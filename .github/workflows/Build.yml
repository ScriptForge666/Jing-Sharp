# .github/workflows/Build.yml
name: Build & Release (CMake)

# ------------------------------------------------------------  
# 触发条件  
# ------------------------------------------------------------  
on:
  push:
    branches: ['**'] # 任意分支 push 时跑 CI
    tags:
      - 'v*.*.*' # 打标签时跑 CI 并产生 Release

# ------------------------------------------------------------  
# 作业 (Job)  
# ------------------------------------------------------------  
jobs:
  # ---------------------- 编译 (矩阵) ----------------------  
  build:
    strategy:
      matrix:
        include:
          # Linux
          - os: ubuntu-22.04
            generator: "Unix Makefiles"
            artifact_ext: tar.gz
            artifact_name: linux
          # macOS
          - os: macos-latest
            generator: "Unix Makefiles"
            artifact_ext: tar.gz
            artifact_name: darwin
          # Windows
          - os: windows-latest
            generator: "Visual Studio 17 2022"
            artifact_ext: zip
            artifact_name: windows
    runs-on: ${{ matrix.os }}

    # ----------------------------------------------------  
    # 1️⃣ 安装依赖 (Linux / macOS)  
    # ----------------------------------------------------  
    - name: Install dependencies (Linux / macOS)
      if: matrix.os == 'ubuntu-22.04' || matrix.os == 'macos-latest'
      run: |
        sudo apt-get update && sudo apt-get install -y build-essential
        brew install --cask xquartz  # macOS 需要 XQuartz

    # ----------------------------------------------------  
    # 2️⃣ 安装依赖 (Windows)  
    # ----------------------------------------------------  
    - name: Install dependencies (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        # Windows 依赖通常由系统自动安装，此处可添加额外配置
        echo "Windows dependencies are already installed."

    # ----------------------------------------------------  
    # 3️⃣ 配置 CMake  
    # ----------------------------------------------------  
    - name: Configure CMake
      run: |
        cmake -S . -B build -G "${{ matrix.generator }}" -DCMAKE_BUILD_TYPE=Release

    # ----------------------------------------------------  
    # 4️⃣ 构建项目  
    # ----------------------------------------------------  
    - name: Build project
      run: |
        cmake --build build --config Release --target all
      shell: bash

    # ----------------------------------------------------  
    # 5️⃣ 打包 (CPack)  
    # ----------------------------------------------------  
    - name: Package (CPack)
      id: cpack
      run: |
        if grep -q "CPACK_GENERATOR" CMakeLists.txt; then
          cmake --build build --target package
        else
          echo "No CPack config – fallback to manual archive"
        fi
      shell: bash

    # ----------------------------------------------------  
    # 6️⃣ 手动压缩 (fallback)  
    # ----------------------------------------------------  
    - name: Manual archive (Linux / macOS)
      if: matrix.os == 'ubuntu-22.04' || matrix.os == 'macos-latest' && (steps.cpack.outcome == 'failure' || steps.cpack.conclusion == 'skipped')
      run: |
        ARCHIVE=${{ matrix.artifact_name }}-${{ github.ref_name }}.${{ matrix.artifact_ext }}
        tar czf $ARCHIVE -C build .
        echo "ARCHIVE=$ARCHIVE" >> $GITHUB_ENV
      shell: bash

    - name: Manual archive (Windows)
      if: matrix.os == 'windows-latest' && (steps.cpack.outcome == 'failure' || steps.cpack.conclusion == 'skipped')
      run: |
        $ARCHIVE = "${{ matrix.artifact_name }}-${{ github.ref_name }}.${{ matrix.artifact_ext }}"
        Compress-Archive -Path build\* -DestinationPath $ARCHIVE
        echo "ARCHIVE=$ARCHIVE" | Out-File -FilePath $env:GITHUB_ENV -Append
      shell: pwsh

    # ----------------------------------------------------  
    # 7️⃣ 上传构建产物（供后面的 release job 使用）  
    # ----------------------------------------------------  
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}-binary
        path: |
          build/*.{zip,tar.gz,deb,dmg}
          ${{ env.ARCHIVE }}

  # -------------------------- Release -----------------------  
  release:
    # 只在符合 vX.Y.Z 格式的 tag 时执行  
    if: ${{ startsWith(github.ref, 'refs/tags/v') }}
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write # 允许运行时使用 GITHUB_TOKEN 创建 Release 并上传资产

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true

      - name: Upload assets to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            ./artifacts/**/*.{zip,tar.gz,deb,dmg}
