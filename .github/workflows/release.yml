name: Build & Release

# åªåœ¨æ‰“ tagï¼ˆv*ï¼‰æ—¶è§¦å‘ã€‚è‹¥æƒ³ä¿ç•™æ‰‹åŠ¨è§¦å‘ï¼Œå¯å¦å»ºä¸€ä¸ª workflowã€‚
on:
  push:
    tags:
      - 'v*'   # ä¾‹å¦‚ v0.9.0ã€v1.2.3

jobs:
  build:
    # ä¸ºæ¯ä¸ªå¹³å°å¹¶è¡Œæ„å»º
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
      fail-fast: false  # å…³é”®ï¼šä¸€ä¸ªå¹³å°å¤±è´¥ï¼Œå…¶ä»–ç»§ç»­æ‰§è¡Œ

    # ----- ç¯å¢ƒå˜é‡ -------------------------------------------------
    env:
      # æŠŠ tag å‰ç¼€â€œvâ€å»æ‰ï¼Œå¾—åˆ°çº¯æ•°å­—ç‰ˆæœ¬å·ï¼Œå¦‚ 0.9.0
      VERSION: ${{ github.ref_name }}
      # ä¸´æ—¶ç›®å½•ï¼Œé˜²æ­¢ä¸å·¥ä½œåŒºå†²çªï¼ˆä¿®å¤ï¼šè¡¥å…¨ github. å‰ç¼€ï¼‰
      TMP_DIR: ${{ github.runner.temp }}

    steps:
      # -----------------------------------------------------------------
      # 1ï¸âƒ£ Checkout æºç 
      # -----------------------------------------------------------------
      - uses: actions/checkout@v3

      # -----------------------------------------------------------------
      # 2ï¸âƒ£ å®‰è£… CMakeï¼ˆè·¨å¹³å°ç»Ÿä¸€ï¼‰
      # -----------------------------------------------------------------
      - name: Set up CMake
        uses: jwlawson/actions-setup-cmake@v1

      # -----------------------------------------------------------------
      # 3ï¸âƒ£ ï¼ˆå¯é€‰ï¼‰å®‰è£…ç¼–è¯‘å™¨å·¥å…·é“¾
      #    Ubuntu/macOS é»˜è®¤å·²æœ‰ gcc/clangï¼ŒWindows ç”¨ VS Build Toolsã€‚
      # -----------------------------------------------------------------
      - name: Install Build Tools (Windows)
        if: github.runner.os == 'Windows'  # ä¿®å¤ï¼šè¡¥å…¨ github. å‰ç¼€
        run: |
          # å·²ç»éš windows-latest è£…å¥½ Visual Studio Build Tools
          echo "VS Build Tools å·²ç»é¢„è£…ï¼Œæ— éœ€é¢å¤–æ“ä½œ"
        shell: pwsh

      # -----------------------------------------------------------------
      # 4ï¸âƒ£ CMake é…ç½® & ç¼–è¯‘ï¼ˆReleaseï¼‰
      # -----------------------------------------------------------------
      - name: Build
        run: |
          mkdir -p build  # ç¡®ä¿ build ç›®å½•å­˜åœ¨
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          # å…¼å®¹ Windows/macOS/Linux çš„ç¼–è¯‘å‘½ä»¤ï¼ˆ--config Release å¯¹ Makefile æ— æ•ˆä½†ä¸æŠ¥é”™ï¼‰
          cmake --build . --config Release --parallel 2  # å¹¶è¡Œç¼–è¯‘ï¼ˆåŠ å¿«é€Ÿåº¦ï¼‰
        shell: bash

      # -----------------------------------------------------------------
      # 5ï¸âƒ£ ç»Ÿä¸€åŒ–ç‰ˆæœ¬å·ï¼ˆå»æ‰å‰ç¼€ â€˜vâ€™ï¼‰ï¼Œå¹¶å¯¼å‡ºä¸º output ä¾›åç»­æ­¥éª¤ä½¿ç”¨
      # -----------------------------------------------------------------
      - name: Normalize version string
        id: version
        run: |
          # å»æ‰å¼€å¤´çš„ "v"
          echo "VERSION=${VERSION#v}" >> $GITHUB_OUTPUT
        shell: bash

      # -----------------------------------------------------------------
      # 6ï¸âƒ£ æ‰“åŒ…ï¼ˆä¿®å¤è·¯å¾„+æƒé™+è°ƒè¯•æ—¥å¿—ï¼‰
      # -----------------------------------------------------------------
      - name: Package
        id: pack
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          OS=${{ github.runner.os }}  # ä¿®å¤ï¼šè¡¥å…¨ github. å‰ç¼€
          ARCH=$(uname -m 2>/dev/null || echo "x64")  # å…¼å®¹ Windows çš„ uname å‘½ä»¤

          # æ ¸å¿ƒï¼šæŒ‡å®šäºŒè¿›åˆ¶æ–‡ä»¶è¾“å‡ºç›®å½•ï¼ˆCMake Release æ¨¡å¼é»˜è®¤è·¯å¾„ï¼‰
          if [[ "$OS" == "Windows" ]]; then
            BIN_DIR="build/Release"
            EXE=peculiarc.exe
            ARCH=x64
            OUT_NAME="peculiarc-windows-${ARCH}-${VERSION}.zip"
          else
            BIN_DIR="build/Release"
            BIN=peculiarc
            # éªŒè¯ Release ç›®å½•ï¼Œä¸å­˜åœ¨åˆ™ fallback åˆ° build æ ¹ç›®å½•
            if [[ ! -d "$BIN_DIR" ]]; then
              echo "âš ï¸  $BIN_DIR ä¸å­˜åœ¨ï¼Œå°è¯• fallback åˆ° build ç›®å½•"
              BIN_DIR="build"
            fi
            # ç¡®å®šç³»ç»Ÿæ¶æ„å’Œè¾“å‡ºæ–‡ä»¶å
            if [[ "$OS" == "Linux" ]]; then
              OUT_NAME="peculiarc-linux-${ARCH}-${VERSION}.tar.gz"
            else  # macOS
              OUT_NAME="peculiarc-macos-${ARCH}-${VERSION}.tar.gz"  # ç”¨å®é™…æ¶æ„ï¼ˆIntel=x86_64ï¼ŒApple Silicon=arm64ï¼‰
            fi
          fi

          # è°ƒè¯•ï¼šè¾“å‡ºå…³é”®è·¯å¾„ä¿¡æ¯
          echo "ğŸ” ç³»ç»Ÿï¼š$OSï¼Œæ¶æ„ï¼š$ARCHï¼Œç‰ˆæœ¬ï¼š$VERSION"
          echo "ğŸ” äºŒè¿›åˆ¶ç›®å½•ï¼š$BIN_DIR"
          echo "ğŸ” ä¸´æ—¶ç›®å½•ï¼š$TMP_DIR"
          ls -l "$BIN_DIR"  # åˆ—å‡ºäºŒè¿›åˆ¶ç›®å½•å†…å®¹ï¼Œæ–¹ä¾¿è°ƒè¯•

          # æ‰“åŒ…é€»è¾‘
          if [[ "$OS" == "Windows" ]]; then
            # Windowsï¼šç”¨ PowerShell å‹ç¼©ï¼Œå…¼å®¹è·¯å¾„æ ¼å¼
            pwsh -Command "
              if (Test-Path '$BIN_DIR\$EXE') {
                Compress-Archive -Path '$BIN_DIR\$EXE' -DestinationPath '$TMP_DIR\$OUT_NAME' -Force
                echo 'âœ… Windows æ‰“åŒ…æˆåŠŸï¼š$TMP_DIR\$OUT_NAME'
              } else {
                echo 'âŒ æ‰¾ä¸åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ï¼š$BIN_DIR\$EXE'
                exit 1
              }
            "
          else
            # Linux/macOSï¼šç”¨ tar æ‰“åŒ…ï¼Œå…ˆéªŒè¯æ–‡ä»¶å­˜åœ¨
            if [[ -f "$BIN_DIR/$BIN" ]]; then
              tar -czvf "$TMP_DIR/$OUT_NAME" -C "$BIN_DIR" "$BIN"
              echo "âœ… Linux/macOS æ‰“åŒ…æˆåŠŸï¼š$TMP_DIR/$OUT_NAME"
            else
              echo "âŒ æ‰¾ä¸åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ï¼š$BIN_DIR/$BIN"
              exit 1
            fi
          fi

          # ç”Ÿæˆ SHA256 æ ¡éªŒæ–‡ä»¶
          cd "$TMP_DIR"
          if [[ "$OS" == "Windows" ]]; then
            # Windows ç”¨ PowerShell ç”Ÿæˆ SHA256
            pwsh -Command "(Get-FileHash -Path '$OUT_NAME' -Algorithm SHA256).Hash | Out-File -FilePath '${OUT_NAME}.sha256' -Encoding ASCII"
          else
            sha256sum "$OUT_NAME" > "${OUT_NAME}.sha256"
          fi

          # è¾“å‡ºæ–‡ä»¶è·¯å¾„ç»™åç»­æ­¥éª¤
          echo "PACKAGE_PATH=$TMP_DIR/$OUT_NAME" >> $GITHUB_OUTPUT
          echo "CHECKSUM_PATH=$TMP_DIR/${OUT_NAME}.sha256" >> $GITHUB_OUTPUT
        shell: bash

      # -----------------------------------------------------------------
      # 7ï¸âƒ£ ä¸Šä¼ è‡³ GitHub Release
      # -----------------------------------------------------------------
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: "Release ${{ steps.version.outputs.VERSION }}"
          generate_release_notes: true
          files: |
            ${{ steps.pack.outputs.PACKAGE_PATH }}
            ${{ steps.pack.outputs.CHECKSUM_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # åªæœ‰æ‰“åŒ…æˆåŠŸæ‰æ‰§è¡Œä¸Šä¼ ï¼ˆå¤±è´¥åˆ™è·³è¿‡ï¼‰
        if: success()