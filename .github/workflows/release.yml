# åœ¨ env ä¸­æ­£ç¡®å®šä¹‰ä¸´æ—¶ç›®å½•ï¼ˆè·¨å¹³å°å…¼å®¹ï¼‰
env:
  VERSION: ${{ github.ref_name }}
  # ä¿®å¤ï¼šä½¿ç”¨ GitHub  runner æä¾›çš„ä¸´æ—¶ç›®å½•çŽ¯å¢ƒå˜é‡
  TMP_DIR: ${{ runner.temp }}  # æ­£ç¡®çš„ä¸´æ—¶ç›®å½•å˜é‡ï¼Œè€Œéž github.runner.temp

# ... å…¶ä»–æ­¥éª¤ä¿æŒä¸å˜ ...

- name: Package
  id: pack
  run: |
    VERSION=${{ steps.version.outputs.VERSION }}
    OS=${{ runner.os }}  # ç»Ÿä¸€ä½¿ç”¨ runner.os å˜é‡
    ARCH=$(uname -m)  # macOS æ— éœ€å…¼å®¹ Windows çš„ç‰¹æ®Šå¤„ç†

    # ä¿®æ­£äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„ï¼ˆæ ¹æ®å®žé™…ç¼–è¯‘è¾“å‡ºï¼Œç¡®è®¤åœ¨ build/src ç›®å½•ï¼‰
    if [[ "$OS" == "Windows" ]]; then
      BIN_DIR="build/src/Release"
      EXE=peculiarc.exe
      ARCH=x64
      OUT_NAME="peculiarc-windows-${ARCH}-${VERSION}.zip"
    else
      BIN_DIR="build/src"  # ä»Žæ—¥å¿—çœ‹ï¼Œå®žé™…äºŒè¿›åˆ¶åœ¨ build/src ç›®å½•
      BIN=peculiarc
      if [[ "$OS" == "Linux" ]]; then
        OUT_NAME="peculiarc-linux-${ARCH}-${VERSION}.tar.gz"
      else  # macOS
        OUT_NAME="peculiarc-macos-${ARCH}-${VERSION}.tar.gz"
      fi
    fi

    # è°ƒè¯•ï¼šç¡®è®¤ä¸´æ—¶ç›®å½•æœ‰æ•ˆ
    echo "ðŸ” ä¸´æ—¶ç›®å½•è·¯å¾„: $TMP_DIR"
    # éªŒè¯ä¸´æ—¶ç›®å½•å¯å†™
    touch "$TMP_DIR/test-write-permission" && echo "âœ… ä¸´æ—¶ç›®å½•å¯å†™" || echo "âŒ ä¸´æ—¶ç›®å½•ä¸å¯å†™"

    # æ‰“åŒ…é€»è¾‘ä¿®æ­£ï¼ˆç¡®ä¿è¾“å‡ºåˆ° TMP_DIRï¼‰
    if [[ "$OS" == "Windows" ]]; then
      pwsh -Command "
        if (Test-Path '$BIN_DIR\$EXE') {
          Compress-Archive -Path '$BIN_DIR\$EXE' -DestinationPath '$TMP_DIR\$OUT_NAME' -Force
        } else { exit 1 }
      "
    else
      if [[ -f "$BIN_DIR/$BIN" ]]; then
        # æ˜Žç¡®æŒ‡å®šè¾“å‡ºåˆ° TMP_DIRï¼Œé¿å…è·¯å¾„é”™è¯¯
        tar -czvf "$TMP_DIR/$OUT_NAME" -C "$BIN_DIR" "$BIN"
      else
        echo "âŒ æ‰¾ä¸åˆ°äºŒè¿›åˆ¶æ–‡ä»¶: $BIN_DIR/$BIN"
        exit 1
      fi
    fi

    # ç”Ÿæˆæ ¡éªŒæ–‡ä»¶ï¼ˆåŒæ ·è¾“å‡ºåˆ° TMP_DIRï¼‰
    cd "$TMP_DIR"
    if [[ "$OS" == "Windows" ]]; then
      pwsh -Command "(Get-FileHash -Path '$OUT_NAME' -Algorithm SHA256).Hash | Out-File -FilePath '${OUT_NAME}.sha256' -Encoding ASCII"
    else
      sha256sum "$OUT_NAME" > "${OUT_NAME}.sha256"
    fi

    echo "PACKAGE_PATH=$TMP_DIR/$OUT_NAME" >> $GITHUB_OUTPUT
    echo "CHECKSUM_PATH=$TMP_DIR/${OUT_NAME}.sha256" >> $GITHUB_OUTPUT
  shell: bash