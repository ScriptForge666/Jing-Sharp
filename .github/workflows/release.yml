name: Build & Release

# åªåœ¨æ‰“ tagï¼ˆv*ï¼‰æ—¶è§¦å‘
on:
  push:
    tags:
      - 'v*'   # ä¾‹å¦‚ v0.9.0ã€v1.2.3

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
      fail-fast: false

    env:
      VERSION: ${{ github.ref_name }}
      TMP_DIR: ${{ github.runner.temp }}

    steps:
      - uses: actions/checkout@v3

      - name: Set up CMake
        uses: jwlawson/actions-setup-cmake@v1

      - name: Install Build Tools (Windows)
        if: github.runner.os == 'Windows'
        run: |
          echo "VS Build Tools å·²ç»é¢„è£…ï¼Œæ— éœ€é¢å¤–æ“ä½œ"
        shell: pwsh

      - name: Build
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release --parallel 2
        shell: bash

      - name: Normalize version string
        id: version
        run: |
          echo "VERSION=${VERSION#v}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Package
        id: pack
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          OS=${{ github.runner.os }}
          ARCH=$(uname -m 2>/dev/null || echo "x64")

          # ä¿®å¤äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„ï¼šä¼˜å…ˆæ£€æŸ¥ build/src ç›®å½•ï¼ˆå›  add_subdirectory(src)ï¼‰
          if [[ "$OS" == "Windows" ]]; then
            BIN_DIR="build/Release/src"  # Windows ä¸‹ src å­ç›®å½•
            EXE=peculiarc.exe
            ARCH=x64
            OUT_NAME="peculiarc-windows-${ARCH}-${VERSION}.zip"
          else
            BIN_DIR="build/src"  # Linux/macOS ä¸‹ src å­ç›®å½•
            BIN=peculiarc
            # éªŒè¯ç›®å½•ï¼Œä¸å­˜åœ¨åˆ™ fallback
            if [[ ! -d "$BIN_DIR" ]]; then
              echo "âš ï¸  $BIN_DIR ä¸å­˜åœ¨ï¼Œå°è¯• fallback åˆ° build ç›®å½•"
              BIN_DIR="build"
            fi
            if [[ "$OS" == "Linux" ]]; then
              OUT_NAME="peculiarc-linux-${ARCH}-${VERSION}.tar.gz"
            else
              OUT_NAME="peculiarc-macos-${ARCH}-${VERSION}.tar.gz"
            fi
          fi

          # è°ƒè¯•ä¿¡æ¯
          echo "ðŸ” ç³»ç»Ÿï¼š$OSï¼Œæž¶æž„ï¼š$ARCHï¼Œç‰ˆæœ¬ï¼š$VERSION"
          echo "ðŸ” äºŒè¿›åˆ¶ç›®å½•ï¼š$BIN_DIR"
          echo "ðŸ” ä¸´æ—¶ç›®å½•ï¼š$TMP_DIR"
          ls -l "$BIN_DIR"

          # æ‰“åŒ…é€»è¾‘
          if [[ "$OS" == "Windows" ]]; then
            pwsh -Command "
              if (Test-Path '$BIN_DIR\$EXE') {
                Compress-Archive -Path '$BIN_DIR\$EXE' -DestinationPath '$TMP_DIR\$OUT_NAME' -Force
                echo 'âœ… Windows æ‰“åŒ…æˆåŠŸï¼š$TMP_DIR\$OUT_NAME'
              } else {
                echo 'âŒ æ‰¾ä¸åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ï¼š$BIN_DIR\$EXE'
                exit 1
              }
            "
          else
            if [[ -f "$BIN_DIR/$BIN" ]]; then
              tar -czvf "$TMP_DIR/$OUT_NAME" -C "$BIN_DIR" "$BIN"
              echo "âœ… Linux/macOS æ‰“åŒ…æˆåŠŸï¼š$TMP_DIR/$OUT_NAME"
            else
              echo "âŒ æ‰¾ä¸åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ï¼š$BIN_DIR/$BIN"
              exit 1
            fi
          fi

          # ç”Ÿæˆ SHA256 æ ¡éªŒæ–‡ä»¶
          cd "$TMP_DIR"
          if [[ "$OS" == "Windows" ]]; then
            pwsh -Command "(Get-FileHash -Path '$OUT_NAME' -Algorithm SHA256).Hash | Out-File -FilePath '${OUT_NAME}.sha256' -Encoding ASCII"
          else
            sha256sum "$OUT_NAME" > "${OUT_NAME}.sha256"
          fi

          echo "PACKAGE_PATH=$TMP_DIR/$OUT_NAME" >> $GITHUB_OUTPUT
          echo "CHECKSUM_PATH=$TMP_DIR/${OUT_NAME}.sha256" >> $GITHUB_OUTPUT
        shell: bash

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: "Release ${{ steps.version.outputs.VERSION }}"
          generate_release_notes: true
          files: |
            ${{ steps.pack.outputs.PACKAGE_PATH }}
            ${{ steps.pack.outputs.CHECKSUM_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: success()